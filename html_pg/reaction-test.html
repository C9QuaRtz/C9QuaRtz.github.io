<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简约反应力测试</title>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f5f5f5;
            --dark: #333333;
            --text: #444444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--text);
            transition: background-color 0.1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 700px;
            padding: 2rem;
        }
        
        .full-screen-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--danger);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        .alert-text {
            font-size: 4rem;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        p {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .instructions {
            margin-bottom: 1.5rem;
        }
        
        strong {
            color: var(--danger);
            font-weight: 600;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            outline: none;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .status-display {
            text-align: center;
            font-size: 1.2rem;
            margin: 1.5rem 0;
            font-weight: 500;
            color: var(--text);
        }
        
        .results {
            display: none;
        }
        
        .stat-card {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.8rem;
            background-color: var(--light);
            border-radius: 4px;
        }
        
        .stat-label {
            font-weight: 500;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }
        
        th {
            background-color: var(--light);
            color: var(--dark);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--light);
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            color: var(--dark);
        }
        
        .flash {
            animation: flash-animation 0.3s;
        }
        
        @keyframes flash-animation {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .settings {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 4px;
        }
        
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .form-group label {
            flex: 1;
            font-weight: 500;
        }
        
        .form-group input {
            flex: 2;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        input[type="number"] {
            width: 100px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .alert-text {
                font-size: 2.5rem;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="full-screen-alert" id="fullScreenAlert">
        <div class="alert-text">点击!</div>
    </div>
    
    <div class="container">
        <div class="card">
            <h1>反应力测试</h1>
            
            <div class="instructions">
                <p>当屏幕变为<strong>红色</strong>时，立即点击屏幕任意位置或按空格键。</p>
                <p>系统会测量您的反应时间并计算统计数据。</p>
            </div>
            
            <div class="settings">
                <div class="form-group">
                    <label for="testCount">测试次数:</label>
                    <input type="number" id="testCount" min="1" max="50" value="10">
                </div>
            </div>
            
            <div class="button-group">
                <button id="startButton" class="btn-primary">开始测试</button>
                <button id="resetButton" class="btn-danger" style="display: none;">重置</button>
            </div>
            
            <div class="status-display" id="status">准备就绪</div>
        </div>
        
        <div class="card results" id="results">
            <div class="section-title">统计数据</div>
            
            <div class="stat-card">
                <span class="stat-label">平均反应时间</span>
                <span class="stat-value"><span id="averageTime">0</span> 毫秒</span>
            </div>
            
            <div class="stat-card">
                <span class="stat-label">最快反应时间</span>
                <span class="stat-value"><span id="bestTime">0</span> 毫秒</span>
            </div>
            
            <div class="stat-card">
                <span class="stat-label">最慢反应时间</span>
                <span class="stat-value"><span id="worstTime">0</span> 毫秒</span>
            </div>
            
            <div class="section-title">详细结果</div>
            
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>测试</th>
                        <th>反应时间 (毫秒)</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const body = document.body;
        const fullScreenAlert = document.getElementById('fullScreenAlert');
        const status = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const results = document.getElementById('results');
        const resultBody = document.getElementById('resultBody');
        const averageTimeSpan = document.getElementById('averageTime');
        const bestTimeSpan = document.getElementById('bestTime');
        const worstTimeSpan = document.getElementById('worstTime');
        const testCountInput = document.getElementById('testCount');
        
        let isWaiting = false;
        let isActive = false;
        let startTime = 0;
        let timeoutId = null;
        let reactionTimes = [];
        let testCount = 0;
        let MAX_TESTS = 10; // 默认值，会被用户输入覆盖
        let testRunning = false;  // 标记测试是否正在进行中
        
        // 跟踪已经处理过的按键，防止重复记录
        let keyProcessed = false;
        
        function startTest() {
            // 获取用户设置的测试次数
            MAX_TESTS = parseInt(testCountInput.value) || 10;
            
            // 限制测试次数范围
            if (MAX_TESTS < 1) MAX_TESTS = 1;
            if (MAX_TESTS > 50) MAX_TESTS = 50;
            testCountInput.value = MAX_TESTS; // 更新输入框值
            
            status.textContent = "准备中...";
            startButton.style.display = "none";
            resetButton.style.display = "inline-block";
            results.style.display = "block";
            
            isWaiting = true;
            isActive = false;
            testRunning = true;  // 设置测试运行状态为真
            keyProcessed = false; // 重置按键处理状态
            
            // 随机延迟1-5秒
            const delay = Math.floor(Math.random() * 4000) + 1000;
            timeoutId = setTimeout(() => {
                fullScreenAlert.style.display = "flex";
                body.classList.add('flash');
                
                startTime = Date.now();
                isActive = true;
                isWaiting = false;
                keyProcessed = false; // 重置按键处理状态
                
                setTimeout(() => {
                    body.classList.remove('flash');
                }, 300);
            }, delay);
        }
        
        function recordReaction() {
            if (isActive && !keyProcessed) {
                keyProcessed = true; // 标记此次测试的按键已处理，防止重复记录
                const reactionTime = Date.now() - startTime;
                reactionTimes.push(reactionTime);
                testCount++;
                
                // 恢复正常显示
                fullScreenAlert.style.display = "none";
                
                // 添加到表格
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>测试 ${testCount}</td>
                    <td>${reactionTime}</td>
                `;
                resultBody.appendChild(row);
                
                // 更新统计数据
                updateStats();
                
                // 设置状态
                status.textContent = `完成测试 ${testCount}/${MAX_TESTS} (${reactionTime} 毫秒)`;
                isActive = false;
                
                // 如果未完成所有测试，继续下一次
                if (testCount < MAX_TESTS) {
                    setTimeout(startTest, 1500);
                } else {
                    status.textContent = "测试完成!";
                    resetButton.textContent = "重新开始";
                    testRunning = false;  // 全部测试完成
                }
            } else if (isWaiting && !keyProcessed) {
                // 过早点击
                keyProcessed = true; // 标记已处理
                clearTimeout(timeoutId);
                status.textContent = "太早了! 请等待屏幕变红";
                isWaiting = false;
                
                setTimeout(() => {
                    startTest();
                }, 1500);
            }
        }
        
        function updateStats() {
            if (reactionTimes.length > 0) {
                const sum = reactionTimes.reduce((a, b) => a + b, 0);
                const avg = Math.round(sum / reactionTimes.length);
                const best = Math.min(...reactionTimes);
                const worst = Math.max(...reactionTimes);
                
                averageTimeSpan.textContent = avg;
                bestTimeSpan.textContent = best;
                worstTimeSpan.textContent = worst;
            }
        }
        
        function resetAll() {
            clearTimeout(timeoutId);
            reactionTimes = [];
            testCount = 0;
            resultBody.innerHTML = '';
            averageTimeSpan.textContent = '0';
            bestTimeSpan.textContent = '0';
            worstTimeSpan.textContent = '0';
            
            status.textContent = "准备就绪";
            fullScreenAlert.style.display = "none";
            
            startButton.style.display = "inline-block";
            resetButton.style.display = "none";
            results.style.display = "none";
            
            isWaiting = false;
            isActive = false;
            testRunning = false;  // 重置测试状态
            keyProcessed = false; // 重置按键处理状态
        }
        
        // 事件监听
        startButton.addEventListener('click', startTest);
        resetButton.addEventListener('click', resetAll);
        
        // 确保测试次数输入是有效的
        testCountInput.addEventListener('change', function() {
            let value = parseInt(this.value) || 10;
            if (value < 1) value = 1;
            if (value > 50) value = 50;
            this.value = value;
        });
        
        // 修改为鼠标按下即触发
        fullScreenAlert.addEventListener('mousedown', (event) => {
            if (isActive && !keyProcessed) {
                recordReaction();
            }
        });
        
        // 全局点击事件改为mousedown
        document.addEventListener('mousedown', (event) => {
            // 检查点击是否在开始按钮或重置按钮上，如果是则不处理
            if (event.target === startButton || event.target === resetButton || event.target === testCountInput) {
                return;
            }
            
            // 只有在测试运行中才处理点击
            if (testRunning) {
                if (isActive && !keyProcessed) {
                    recordReaction();
                } else if (isWaiting && !keyProcessed) {
                    // 过早点击
                    keyProcessed = true;
                    clearTimeout(timeoutId);
                    status.textContent = "太早了! 请等待屏幕变红";
                    isWaiting = false;
                    
                    setTimeout(() => {
                        startTest();
                    }, 1500);
                }
            }
        });
        
        // 监听空格键按下 - 不需要等待keyup
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                event.preventDefault();
                
                if (!testRunning) {
                    // 如果测试未运行，且开始按钮可见，则启动测试
                    if (startButton.style.display !== 'none') {
                        startTest();
                    }
                    return;
                }
                
                if (isActive && !keyProcessed) {
                    recordReaction();
                } else if (isWaiting && !keyProcessed) {
                    // 过早点击
                    keyProcessed = true;
                    clearTimeout(timeoutId);
                    status.textContent = "太早了! 请等待屏幕变红";
                    isWaiting = false;
                    
                    setTimeout(() => {
                        startTest();
                    }, 1500);
                }
            }
        });
    </script>
</body>
</html>
